name: Full Stack Build with Repository Dispatch

# WORKFLOW ALTERNATIVO - Só executa quando disparado pelo frontend ou manualmente
on:
  # push:
  #   branches: [main]
  # pull_request:
  #   branches: [main]
  repository_dispatch:
    types: [frontend-updated]
  workflow_dispatch:  # Execução manual

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      # Checkout backend
      - name: Checkout Backend
        uses: actions/checkout@v3
        with:
          path: backend

      # Checkout frontend repository and build it (avoid relying on Releases)
      - name: Checkout Frontend
        uses: actions/checkout@v3
        with:
          repository: felipeesser/projetotestefront
          path: frontend
          token: ${{ secrets.FRONTEND_PAT_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: './frontend/package-lock.json'

      - name: Install frontend dependencies
        run: npm ci
        working-directory: ./frontend

      - name: Build frontend
        run: npm run build
        working-directory: ./frontend

      # Copy frontend build to backend resources
      - name: Copy frontend to backend
        run: |
          echo "Listing frontend dist directory structure:"
          ls -la ./frontend/dist || true
          mkdir -p ./backend/src/main/resources/META-INF/resources
          if [ -d "./frontend/dist/teste-quarkus-sgbd/browser" ]; then
            echo "Copying from Angular v17+ browser directory"
            cp -r ./frontend/dist/teste-quarkus-sgbd/browser/* ./backend/src/main/resources/META-INF/resources/
          elif [ -d "./frontend/dist/teste-quarkus-sgbd" ]; then
            echo "Copying from standard Angular directory"
            cp -r ./frontend/dist/teste-quarkus-sgbd/* ./backend/src/main/resources/META-INF/resources/
          else
            echo "Copying from dist root"
            cp -r ./frontend/dist/* ./backend/src/main/resources/META-INF/resources/
          fi
          echo "Final backend resources structure:"
          ls -la ./backend/src/main/resources/META-INF/resources/ || true

      # Continue with backend build...
      - name: Set executable permissions for mvnw
        run: chmod +x ./backend/mvnw

      - name: Set up JDK 21
        uses: actions/setup-java@v3
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Build with Maven (Native)
        run: ./mvnw package -Dnative
        working-directory: ./backend

      # Log in to Docker Hub
      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build Docker image
        run: docker build -f src/main/docker/Dockerfile.integrated -t ${{ secrets.DOCKER_USERNAME }}/projetoteste:latest .
        working-directory: ./backend

      - name: Push Docker image
        run: docker push ${{ secrets.DOCKER_USERNAME }}/projetoteste:latest