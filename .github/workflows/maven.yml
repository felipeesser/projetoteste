name: Java CI with Docker Build

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # Checkout backend repository (current repo)
      - name: Checkout Backend
        uses: actions/checkout@v3
        with:
          path: backend

      # Checkout frontend repository
      - name: Checkout Frontend
        uses: actions/checkout@v3
        with:
          repository: felipeesser/projetotestefront  # substitua pelo nome real do repo do frontend
          path: frontend
          token: ${{ secrets.FRONTEND_PAT_TOKEN }}  # Use para repo privado

      # Garantir permissões de execução para o Maven Wrapper
      - name: Set executable permissions for mvnw
        run: chmod +x ./backend/mvnw

      # Set up Java
      - name: Set up JDK 21
        uses: actions/setup-java@v3
        with:
          java-version: '21'
          distribution: 'temurin'

      # Cache Maven dependencies
      - name: Cache Maven dependencies
        uses: actions/cache@v3
        with:
          path: ~/.m2
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      # Install Node.js for frontend build
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: './frontend/package-lock.json'

      # Build frontend
      - name: Install frontend dependencies
        run: npm ci
        working-directory: ./frontend

      - name: Build frontend
        run: npm run build
        working-directory: ./frontend

      # Run Maven tests
      - name: Run tests
        run: ./mvnw test
        working-directory: ./backend

      # Copy frontend build to backend resources
      - name: Copy frontend to backend
        run: |
          echo "Listing frontend dist directory structure:"
          find ./frontend/dist -type f -name "*.html" -o -name "*.js" -o -name "*.css" | head -10
          mkdir -p ./backend/src/main/resources/META-INF/resources
          
          # Angular v17+ puts files in browser/ subdirectory
          if [ -d "./frontend/dist/teste-quarkus-sgbd/browser" ]; then
            echo "Copying from Angular v17+ browser directory"
            cp -r ./frontend/dist/teste-quarkus-sgbd/browser/* ./backend/src/main/resources/META-INF/resources/
          elif [ -d "./frontend/dist/teste-quarkus-sgbd" ]; then
            echo "Copying from standard Angular directory"  
            cp -r ./frontend/dist/teste-quarkus-sgbd/* ./backend/src/main/resources/META-INF/resources/
          else
            echo "Copying from dist root"
            cp -r ./frontend/dist/* ./backend/src/main/resources/META-INF/resources/
          fi
          
          echo "Final backend resources structure:"  
          find ./backend/src/main/resources/META-INF/resources -type f | head -10

      # Build the application in native mode
      - name: Build with Maven (Native)
        run: ./mvnw package -Dnative
        working-directory: ./backend

      # Log in to Docker Hub
      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # Build the Docker image
      - name: Build Docker image
        run: docker build -f src/main/docker/Dockerfile.integrated -t ${{ secrets.DOCKER_USERNAME }}/projetoteste:latest .
        working-directory: ./backend

      # Push the Docker image
      - name: Push Docker image
        run: docker push ${{ secrets.DOCKER_USERNAME }}/projetoteste:latest
